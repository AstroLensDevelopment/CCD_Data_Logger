name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build for Android
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    container:
      image: kivy/buildozer:latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Cache Buildozer global directory
      uses: actions/cache@v3
      with:
        path: .buildozer_global
        key: buildozer-global-${{ hashFiles('buildozer.spec') }}

    - name: Build with Buildozer
      run: |
        buildozer android debug
      env:
        BUILDOZER_WARN_ON_ROOT: 0
        APP_ANDROID_ACCEPT_SDK_LICENSE: 1

    - name: Verify APK was created
      run: |
        echo "Searching for APK files..."
        find . -name "*.apk" -type f
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "✓ APK file found in bin/"
          for apk in bin/*.apk; do
            echo "APK: $apk ($(du -h "$apk" | cut -f1))"
          done
        else
          echo "⚠ No APK in bin/, checking .buildozer..."
          if find .buildozer -name "*.apk" -type f | grep -q .; then
            echo "Found APK in .buildozer, copying to bin/"
            mkdir -p bin
            find .buildozer -name "*.apk" -type f -exec cp {} bin/ \;
            ls -lh bin/
          else
            echo "❌ No APK files found anywhere"
            exit 1
          fi
        fi

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ccddatalogger-apk
        path: bin/*.apk

    - name: Build log on failure  
      if: failure()
      run: |
        echo "Build failed. Checking for logs..."
        find .buildozer -name "*.log" -type f | head -5 | while read log; do
          echo "=== $log (last 100 lines) ==="
          tail -100 "$log"
        done
