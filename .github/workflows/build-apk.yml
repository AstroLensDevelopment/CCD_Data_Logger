name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build for Android
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Cache Buildozer global directory
      uses: actions/cache@v3
      with:
        path: .buildozer_global
        key: buildozer-global-${{ hashFiles('buildozer.spec') }}

    - name: Build with Buildozer
      uses: ArtemSBulgakov/buildozer-action@v1
      id: buildozer
      with:
        command: buildozer android debug
        buildozer_version: stable

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ccddatalogger-apk
        path: ${{ steps.buildozer.outputs.filename }}

    - name: Copy APK to bin directory
      if: success()
      run: |
        mkdir -p bin
        if [ -f "${{ steps.buildozer.outputs.filename }}" ]; then
          cp "${{ steps.buildozer.outputs.filename }}" bin/
          echo "✓ APK copied to bin directory"
          ls -lh bin/
        else
          echo "⚠ APK file not found"
        fi

    - name: Build log on failure
      if: failure()
      run: |
        echo "Build failed. Checking for logs..."
        if [ -f ".buildozer/android/platform/build-arm64-v8a/build.log" ]; then
          echo "Last 200 lines of build log:"
          tail -200 .buildozer/android/platform/build-arm64-v8a/build.log
        fi
          exit 1
        fi
        
        echo "✓ APK copied to bin/"
        ls -lah bin/

    - name: Verify APK was created
      run: |
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "✓ APK file found!"
          for apk in bin/*.apk; do
            echo "APK: $apk ($(du -h "$apk" | cut -f1))"
          done
        else
          echo "❌ No APK files in bin/"
          exit 1
        fi

    - name: Upload build log (always)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
        retention-days: 7

    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ccddatalogger-apk
        path: bin/*.apk
        retention-days: 30

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
